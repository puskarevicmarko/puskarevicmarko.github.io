<!DOCTYPE html>
<html dir="ltr">

<head>
  <meta charset="UTF-8">
  <title>Cupertino Pane - Overflow</title>

  <!--Mapbox-->
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
  <script src='https://npmcdn.com/csv2geojson@latest/csv2geojson.js'></script>
  <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

  <!--Tailwind-->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script>var exports = {"__esModule": true};</script> <!-- Required if exports not defined earlier -->
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.js"></script>
  <script src="https://unpkg.com/cupertino-pane/dist/cupertino-pane.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"/> 
  <style>
    ion-drawer { padding: 0 20px; }
    ion-drawer .content {
      overflow-y: auto !important;
    }
    ion-drawer h1 {
      margin: 0;
      padding-bottom: 10px;
      border-bottom: 1px solid #ccc;
    }
  </style>
</head>

<body>
    <div class="absolute inset-0" id='map'></div>
                    <script>
                    mapboxgl.accessToken = 'pk.eyJ1IjoicHVza2FyZXZpY21hcmtvIiwiYSI6ImNsOGM0ODN2ZzBkaG4zb245MXMyd3o3ZGkifQ.e6UX1du_kGFp5YzHVrnMLw';
                    var map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/puskarevicmarko/cl1v306x6006a14s2064gtpmd',
                        center: [-73.991556,40.744972], // starting position [lng, lat]
                        zoom: 12, // starting zoom
                    });
                
                    $(document).ready(function () {
                    $.ajax({
                        type: "GET",
                        url: 'https://docs.google.com/spreadsheets/d/1TJ30712MKFqUTv-EiLfaFQnJ_Gb7qwJBh5U5unOVkRU/gviz/tq?tqx=out:csv&sheet=Sheet1',
                        dataType: "text",
                        success: function (csvData) { makeGeoJSON(csvData); }
                    });
        
                    function makeGeoJSON(csvData) {
                            csv2geojson.csv2geojson(csvData, {
                            latfield: 'Latitude',
                            lonfield: 'Longitude',
                            delimiter: ','
                            }, function (err, data) {
                            map.on('load', function () {
                                
                                data.features.forEach((datum)=>{
                                    datum.properties.HeinosityIndex = parseInt(datum.properties.HeinosityIndex)
                                })
                                //Add the the layer to the map
                                
                                map.addLayer({
                                'id': 'places',
                                'type': 'circle',
                                'source': {
                                    'type': 'geojson',
                                    'data': data
                                },
                                'paint': {
                                    'circle-stroke-color': '#FFCA2A',
                                    'circle-opacity': 1,
                                    'circle-radius': 
                                        {stops: [
                                            [10, 1],
                                            [14, 13],
                                        ]},
                                    'circle-stroke-width': 0,
                                    'circle-color': {
                                        property: 'HeinosityIndex',
                                        stops: [
                                        [10, '#FFCA2A'],
                                        [50, '#EE352E'],
                                    ]
                                    },
                                }
                                });
        
                                // Create a popup, but don't add it to the map yet.
                                const popup = new mapboxgl.Popup({
                                closeButton: false,
                                closeOnClick: false
                                });
                                
                                map.on('mouseenter', 'places', (e) => {
                                // Change the cursor style as a UI indicator.
                                map.getCanvas().style.cursor = 'pointer';
                                
                                // Copy coordinates array.
                                const coordinates = e.features[0].geometry.coordinates.slice();
                                const description = e.features[0].properties.Address;
                                const name = e.features[0].properties.Name;
        
                                
                                // Ensure that if the map is zoomed out such that multiple
                                // copies of the feature are visible, the popup appears
                                // over the copy being pointed to.
                                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                                }
                                
                                // Populate the popup and set its coordinates
                                // based on the feature found.
                                popup.setLngLat(coordinates).setHTML(name).addTo(map);
                                });
                            
                                map.on('click', 'places', (e) => {
                                    let index = parseInt(e.features[0].properties.Address,10);
        
                                    stories.add({
                                    id: index,
                                    photo: e.features[0].properties.MapsImg,
                                    name: e.features[0].properties.Name,
                                    time: timestamp(),
                                    items: [
                                        {
                                            id: 'test1',
                                            type: 'photo',
                                            src: e.features[0].properties.FirstStory,
                                            preview: e.features[0].properties.FirstStory,
                                            length: 3,
                                            link: 'https://ramon.codes',
                                            linkText: "Blank", 
                                        }
                                        ]
                                     }
                                    )
                                    
                                    //document.querySelectorAll('#stories .story')[0].click();
                                    myPane.moveToBreak('top');
                                });
                                
                                map.on('mouseleave', 'places', () => {
                                map.getCanvas().style.cursor = '';
                                popup.remove();
                                });
        
                            });
        
                            });
                        };
                        });
                    </script> 
  <ion-content scroll-y="false">
      <ion-drawer>
        <h1 class="ion-padding">Header</h1>
        
        <div class="content" overflow-y>
          <ion-list hide-on-bottom>
            <ion-list-header>
              Recent Conversations
            </ion-list-header>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Finn</h2>
                <h3>I'm a big deal</h3>
                <p>Listen, I've had a pretty messed up day...</p>
              </ion-label>
            </ion-item>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Han</h2>
                <h3>Look, kid...</h3>
                <p>I've got enough on my plate as it is, and I...</p>
              </ion-label>
            </ion-item>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Rey</h2>
                <h3>I can handle myself</h3>
                <p>You will remove these restraints and leave...</p>
              </ion-label>
            </ion-item>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Luke</h2>
                <h3>Your thoughts betray you</h3>
                <p>I feel the good in you, the conflict...</p>
              </ion-label>
            </ion-item>
          </ion-list>
    
          <ion-list>
            <ion-list-header>
              Online
            </ion-list-header>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Poe</h2>
                <h3>New Ride</h3>
                <p>I just upgraded my X-Wing. Next time...</p>
              </ion-label>
            </ion-item>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Ben</h2>
                <h3>Move Along</h3>
                <p>These aren't the droids you're looking for...</p>
              </ion-label>
            </ion-item>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Leia</h2>
                <h3>You're My Only Hope</h3>
                <p>I've placed information vital to the survival...</p>
              </ion-label>
            </ion-item>
    
            <ion-item>
              <ion-avatar slot="start">
                <img src="https://ionicframework.com/docs/demos/api/avatar/avatar.svg">
              </ion-avatar>
              <ion-label>
                <h2>Yoda</h2>
                <h3>Size matters not</h3>
                <p>Do or do not. There is no try...</p>
              </ion-label>
            </ion-item>
          </ion-list>
        </div>
      </ion-drawer>

      <ion-button expand="block" color="danger" onclick="presentDrawer()">Present Drawer</ion-button>
      <ion-button expand="block" color="danger" onclick="destroyDrawer()">Destroy Drawer</ion-button>

   
  </ion-content>
  <script> 
    let topHeight = 700;
    let middleHeight = 350;
    let content = document.querySelector('ion-drawer .content');
    var drawer = new CupertinoPane('ion-drawer', { 
        breaks: {
          top: { enabled: true, height: topHeight },
          middle: { enabled: true, height: middleHeight },
          bottom: { enabled: true, offset: 90 }
        },
        initialBreak: 'middle',
        dragBy: ['.draggable', 'ion-drawer h1'],
        events: {
          onDrag: () => {
            content.style.height = `${window.screen.height 
              - getPaneTransformY() 
              - content.offsetTop}px`;
              content.setAttribute('style', 'overflow-y: hidden !important');
          },
          onDidPresent: () => {
                    content.setAttribute('style', 'overflow-y: auto !important');
                    content.style.height = `${middleHeight - content.offsetTop}px`;
          },
          onTransitionEnd: () => {
            setTimeout(() => {
               setHeight();
            }, 200)
          }
        }
    });
    window.onload = function() {
    setTimeout(() => drawer.present({animate: true}), 300);      
    }


    function setHeight() {

            content.setAttribute('style', 'overflow-y: auto !important');
            if (drawer.currentBreak() === 'top') {
              content.style.height = `${topHeight - content.offsetTop}px`;
            }
            if (drawer.currentBreak() === 'middle') {
              content.style.height = `${middleHeight - content.offsetTop}px`;
            }
    }

    function getPaneTransformY() {
      const translateYRegex = /\.*translateY\((.*)px\)/i;
      const paneEl = document.querySelector('.pane');
      return paneEl ? parseFloat(translateYRegex.exec(paneEl.style.transform)[1]) : 0;
    }

    async function presentDrawer() {
      drawer.present({animate: true});
    };

    async function destroyDrawer() {
      drawer.destroy({animate: true});
    };
    
    async function hideDrawer() {
      drawer.hide();
    };

    async function isHiddenDrawer() {
        console.log(await drawer.isHidden());
    };

    async function setTopDrawer() {
      drawer.moveToBreak('top');
    };

    async function setMiddleDrawer() {
      drawer.moveToBreak('middle');
    };

    async function setBottomDrawer() {
      drawer.moveToBreak('bottom');
    };
  </script>
</body>

</html>