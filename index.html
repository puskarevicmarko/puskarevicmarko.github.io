<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>DownBad.nyc</title>
        <!-- Chrome, Firefox OS and Opera -->
        <meta name="theme-color" content="#FFCA2A">
        <!-- iOS Safari -->
        <meta name="apple-mobile-web-app-status-bar-style" content="#FFCA2A">
        <meta name="description" content="Manhattan's Most Memed">
        <link rel="stylesheet" href="https://unpkg.com/zuck.js/dist/zuck.css" />
        <link rel="stylesheet" href="styles.css">
        <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' /> 

        <script type="module" src="https://cdn.ampproject.org/bento.mjs"></script>
        <script nomodule src="https://cdn.ampproject.org/bento.js"></script>
        <script type="module" src="https://cdn.ampproject.org/v0/bento-instagram-1.0.mjs"></script>
        <script nomodule src="https://cdn.ampproject.org/v0/bento-instagram-1.0.js"></script>
        <style>
            bento-instagram {
              display: block;
              overflow: hidden;
              position: relative;

              width: 100%;
              height: 700px;
            }

          </style>

        <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <script>var exports = {"__esModule": true};</script> <!-- Required if exports not defined earlier -->
        <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core/dist/ionic/ionic.esm.js"></script>
        <script src="https://unpkg.com/cupertino-pane/dist/cupertino-pane.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core/css/ionic.bundle.css"/> 
        
        
        <!--Mapbox-->
        <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.js'></script>
        <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.1/mapbox-gl.css' rel='stylesheet' />
        <script src='https://npmcdn.com/csv2geojson@latest/csv2geojson.js'></script>
        <script src='https://npmcdn.com/@turf/turf/turf.min.js'></script>

        <!--Tailwind-->
        <script src="https://cdn.tailwindcss.com"></script>

        <!--Cupertino1-->
        <script src="https://unpkg.com/cupertino-pane/dist/cupertino-pane.js"></script>
        <script src="https://unpkg.com/cupertino-pane/dist/cupertino-pane.min.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.0/jquery.min.js"></script>

        <!-- Global site tag (gtag.js) - Google Analytics -->
        <!--<script async src="https://www.googletagmanager.com/gtag/js?id=UA-163683928-1"></script>
        <script>
             window.dataLayer = window.dataLayer || [];
             function gtag(){dataLayer.push(arguments);}
             gtag('js', new Date());
             gtag('config', 'UA-163683928-1');
         </script>      -->

         <!-- Load the `mapbox-gl-geocoder` plugin. -->
        <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
        <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    </head>
    <body>
        <section scroll-y="false">
            <ion-drawer>
                <h1 id="location" class="ion-padding">Heinosities</h1>
                <div id="button-group" class="py-2 pl-4 flex justify-left items-center space-x-4 overflow-x-auto">
                    <h2 class="flex-shrink-0">Associated: </h2>
                    <div id="tags" class="flex-shrink-0"></div>
                 </div>
                <div class="content" overflow-y>
                    <div id="p1"></div>       
                    <div id="p2"></div>       
                    <div class="h-fit" id="p3"></div>       
                    <div id="p4"></div>       
                    <div id="p5"></div>       
                    <div id="p6"></div>       
                    <div id="p7"></div>       
                    <div id="p8"></div>       
                    <div id="p9"></div>       
                    <div id="p10"></div>       
                    <div id="p11"></div>       
                    <div id="p12"></div>       
                    <div id="p13"></div>       
                    <div id="p14"></div>       
                    <div id="p15"></div>       
                    <div id="p16"></div>       
                    <div id="p17"></div>       
                    <div id="p18"></div>       
                    <div id="p19"></div>    
                    <div id="p20"></div>       
                </div>
            </ion-drawer>
      
            <div class="container px-6 pt-6 mx-auto flex justify-center overflow-auto">
                <div class="w-full md:w-2/3 lg:w-1/2 full bg-yellow-500 bg-opacity-75 rounded-2xl flex flex-col relative z-10 shadow-2xl overflow-hidden">
                      <div class="flex items-center bg-yellow-500 flex-col items-start px-6 py-5">
                          <img src="DOWN BAD!.png" class="object-contain md:h-12">
                          <img src="MANHATTANâ€™S MOST MEMED.svg" class="object-contain md:h-5">
                          <p>Test</p>
                        </div>
                  </div>
  
                </div>

            <div class="absolute inset-0" id='map' data-tap-disabled="true"></div>
            <script>
            mapboxgl.accessToken = 'pk.eyJ1IjoicHVza2FyZXZpY21hcmtvIiwiYSI6ImNsOGM0ODN2ZzBkaG4zb245MXMyd3o3ZGkifQ.e6UX1du_kGFp5YzHVrnMLw';
            
            var map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/puskarevicmarko/cl1v306x6006a14s2064gtpmd',
                center: [-73.991556,40.744972], // starting position [lng, lat]
                zoom: 12, // starting zoom
                trackResize: false,
            }); 

            map.on('load', function() {
              // Set the size of the map to the size of the container
              map.resize();
            });

            // Add the control to the map.
            /*
            map.addControl(
            new MapboxGeocoder({
              accessToken: mapboxgl.accessToken,
              mapboxgl: mapboxgl,
              position: "bottom-right",
            })
            );*/
            
            $(document).ready(function () {
                    $.ajax({
                        type: "GET",
                        url: 'https://docs.google.com/spreadsheets/d/1TJ30712MKFqUTv-EiLfaFQnJ_Gb7qwJBh5U5unOVkRU/gviz/tq?tqx=out:csv&sheet=Sheet1',
                        dataType: "text",
                        success: function (csvData) { makeGeoJSON(csvData); }
                    });
                    
                    function makeGeoJSON(csvData) {
                            csv2geojson.csv2geojson(csvData, {
                            latfield: 'Latitude',
                            lonfield: 'Longitude',
                            delimiter: ','
                            }, function (err, data) {
                            map.on('load', function () {
                                
                                data.features.forEach((datum)=>{
                                    datum.properties.HeinosityIndex = parseInt(datum.properties.HeinosityIndex)
                                });
                                
                                map.addLayer({
                                'id': 'places',
                                'type': 'circle',
                                'source': {
                                    'type': 'geojson',
                                    'data': data
                                },
                                'paint': {
                                    'circle-stroke-color': '#FFCA2A',
                                    'circle-opacity': 1,
                                    'circle-radius': 
                                        {stops: [
                                            [10, 1],
                                            [14, 13],
                                        ]},
                                    'circle-stroke-width': 0,
                                    'circle-color': {
                                        property: 'HeinosityIndex',
                                        stops: [
                                        [1, '#f7b731'],
                                        [3, '#FD9A01'],
                                        [5, '#FF2C05'],
                                        [21, '#F00505'],
                                    ]
                                    },
                                }
                                });
        
                                // Create a popup, but don't add it to the map yet.
                                const popup = new mapboxgl.Popup({
                                closeButton: false,
                                closeOnClick: false
                                });
                                
                                map.on('mouseenter', 'places', (e) => {
                                // Change the cursor style as a UI indicator.
                                map.getCanvas().style.cursor = 'pointer';
                                
                                // Copy coordinates array.
                                const coordinates = e.features[0].geometry.coordinates.slice();
                                const description = e.features[0].properties.Address;
                                const name = e.features[0].properties.Name;


                                // Ensure that if the map is zoomed out such that multiple
                                // copies of the feature are visible, the popup appears
                                // over the copy being pointed to.
                                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                                coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                                }
                                
                                // Populate the popup and set its coordinates
                                // based on the feature found.
                                popup.setLngLat(coordinates).setHTML(name).addTo(map);
                                });
                            
                                
                                map.on('click', 'places', (e) => {
                                    document.getElementById("location").innerHTML = e.features[0].properties.Name;   
                                    
                                    document.getElementById("tags").innerHTML = e.features[0].properties.Tags;            

                                    document.getElementById("p1").innerHTML = e.features[0].properties.Post1;            
                                    document.getElementById("p2").innerHTML = e.features[0].properties.Post2;
                                    document.getElementById("p3").innerHTML = e.features[0].properties.Post3;
                                    document.getElementById("p4").innerHTML = e.features[0].properties.Post4;
                                    document.getElementById("p5").innerHTML = e.features[0].properties.Post5;
                                    document.getElementById("p6").innerHTML = e.features[0].properties.Post6;
                                    document.getElementById("p7").innerHTML = e.features[0].properties.Post7;
                                    document.getElementById("p8").innerHTML = e.features[0].properties.Post8;
                                    document.getElementById("p9").innerHTML = e.features[0].properties.Post9;
                                    document.getElementById("p10").innerHTML = e.features[0].properties.Post10;
                                    document.getElementById("p11").innerHTML = e.features[0].properties.Post11;
                                    document.getElementById("p12").innerHTML = e.features[0].properties.Post12;
                                    document.getElementById("p13").innerHTML = e.features[0].properties.Post13;
                                    document.getElementById("p14").innerHTML = e.features[0].properties.Post14;
                                    document.getElementById("p15").innerHTML = e.features[0].properties.Post15;
                                    document.getElementById("p16").innerHTML = e.features[0].properties.Post16;
                                    document.getElementById("p17").innerHTML = e.features[0].properties.Post17;
                                    document.getElementById("p18").innerHTML = e.features[0].properties.Post18;
                                    document.getElementById("p19").innerHTML = e.features[0].properties.Post19;
                                    document.getElementById("p20").innerHTML = e.features[0].properties.Post20;
                                    
                                    presentDrawer();

                                    map.flyTo({
                                    center: e.features[0].geometry.coordinates
                                    });
                                    let index = parseInt(e.features[0].properties.Address,10);
                                    
                                    /*
                                    stories.add({
                                    id: index,
                                    photo: e.features[0].properties.MapsImg,
                                    name: e.features[0].properties.Name,
                                    time: timestamp(),
                                    items: [
                                        {
                                            id: 'test1',
                                            type: 'photo',
                                            src: e.features[0].properties.FirstStory,
                                            preview: e.features[0].properties.FirstStory,
                                            length: 3,
                                            link: 'https://ramon.codes',
                                            linkText: "Blank", 
                                        }
                                        ]
                                     }
                                    )*/
                                    //document.querySelectorAll('#stories .story')[0].click();
                                    

                                });
                                
                                map.on('mouseleave', 'places', () => {
                                map.getCanvas().style.cursor = '';
                                popup.remove();
                                });
        
                            });
        
                            });
                        };
                        });
            </script>
            
            
        </section>
        <script> 
            let topHeight = 600;
            let middleHeight = 300;
            let content = document.querySelector('ion-drawer .content');
            var drawer = new CupertinoPane('ion-drawer', { 
                breaks: {
                  top: { enabled: true, height: topHeight },
                  middle: { enabled: true, height: middleHeight },
                  bottom: { enabled: true, offset: 90 }
                },
                initialBreak: 'top',
                buttonDestroy: false,
                fastSwipeClose: true,
                dragBy: ['.draggable', 'ion-drawer h1'],
                events: {
                  onDrag: () => {
                    content.style.height = `${window.screen.height 
                      - getPaneTransformY() 
                      - content.offsetTop}px`;
                      content.setAttribute('style', 'overflow-y: hidden !important');
                  },
                  onDidPresent: () => {
                            content.setAttribute('style', 'overflow-y: auto !important');
                            content.style.height = `${middleHeight - content.offsetTop}px`;
                  },
                  onTransitionEnd: () => {
                    setTimeout(() => {
                       setHeight();
                    }, 200)
                  }
                }
            });
            
            /*window.onload = function() {
            setTimeout(() => drawer.present({animate: true}), 300);    
            //drawer.preventDismiss(true);
            }*/
        
            function setHeight() {
        
                    content.setAttribute('style', 'overflow-y: auto !important');
                    if (drawer.currentBreak() === 'top') {
                      content.style.height = `${topHeight - content.offsetTop}px`;
                    }
                    if (drawer.currentBreak() === 'middle') {
                      content.style.height = `${middleHeight - content.offsetTop}px`;
                    }
            }
        
            function getPaneTransformY() {
              const translateYRegex = /\.*translateY\((.*)px\)/i;
              const paneEl = document.querySelector('.pane');
              return paneEl ? parseFloat(translateYRegex.exec(paneEl.style.transform)[1]) : 0;
            }
        
            async function presentDrawer() {
              drawer.present({animate: true});
            };
        
            async function destroyDrawer() {
              drawer.destroy({animate: true});
            };
            
            async function hideDrawer() {
              drawer.hide();
            };
        
            async function isHiddenDrawer() {
                console.log(await drawer.isHidden());
            };
        
            async function setTopDrawer() {
              drawer.moveToBreak('top');
            };
        
            async function setMiddleDrawer() {
              drawer.moveToBreak('middle');
            };
        
            async function setBottomDrawer() {
              drawer.moveToBreak('bottom');
            };

            async function presentTop(){
                presentDrawer();
                setTopDrawer();
            }
            
            function flyTo(latitude, longitude, description) {
            // Use Mapbox GL JS to fly to the specified coordinates

            destroyDrawer();

            map.flyTo({
              center: [longitude, latitude],
              zoom: 15
            });

            // Create a popup and add it to the map
            new mapboxgl.Popup({
              closeButton: false,
            })
              .setLngLat([longitude, latitude])
              .setHTML(description)
              .addTo(map);
          }
          </script>
      </body>
</html>